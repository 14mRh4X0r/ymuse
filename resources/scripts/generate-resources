#!/usr/bin/env bash
# Generates .go source file from resources. For now only .glade files are processed

set -e

root_dir="$(dirname "$(dirname "$(dirname "$(realpath "$0")")")")"

# Drop the generated file, if any
resources_file="$root_dir/internal/generated/resources.go"
rm -f "$resources_file"

# Create the generated package dir if needed
mkdir -p "$(dirname "$resources_file")"

# Create file header
echo "Creating file $resources_file"
cat <<EOF >"$resources_file"
package generated

// Code generated by $0 - DO NOT EDIT
EOF

# Iterate through all available resource files
find "$root_dir" -type f -name '*.glade' |
    while read file; do
        # Compose function name as Get + capitalised words from the base file name
        func_name="$(echo Get "$(basename "$file")" | sed -re 's/\b([a-z]+)/\u\1/g' -re 's/[^a-z]+//gi')"
        echo "File: $file; function: $func_name"

        # Insert a blank line
        echo >> "$resources_file"

        # Write out a doc comment
        echo "// $func_name returns the contents stored in the file $file" >> "$resources_file"

        # Write out the function declaration
        echo "func $func_name() string {" >> "$resources_file"
        echo -ne '\treturn `' >> "$resources_file"

        # Dump file contents
        cat "$file" >> "$resources_file"

        # Close the literal and the function
        echo '`' >> "$resources_file"
        echo '}' >> "$resources_file"
    done

